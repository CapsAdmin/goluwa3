local T = require("test.t")
local Matrix44 = require("structs.matrix").Matrix44

T.test("Matrix44 identity construction", function()
	local m = Matrix44()
	T(m.m00)["=="](1)
	T(m.m11)["=="](1)
	T(m.m22)["=="](1)
	T(m.m33)["=="](1)
	T(m.m01)["=="](0)
	T(m.m10)["=="](0)
end)

T.test("Matrix44 identity method", function()
	local m = Matrix44(2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 2)
	m:Identity()
	T(m.m00)["=="](1)
	T(m.m11)["=="](1)
	T(m.m22)["=="](1)
	T(m.m33)["=="](1)
end)

T.test("Matrix44 copy", function()
	local m1 = Matrix44()
	m1.m00 = 5
	local m2 = m1:Copy()
	T(m2.m00)["=="](5)
	m2.m00 = 10
	T(m1.m00)["=="](5)
end)

T.test("Matrix44 translation", function()
	local m = Matrix44()
	m:SetTranslation(10, 20, 30)
	T(m.m30)["=="](10)
	T(m.m31)["=="](20)
	T(m.m32)["=="](30)
end)

T.test("Matrix44 GetTranslation", function()
	local m = Matrix44()
	m:SetTranslation(5, 10, 15)
	local x, y, z = m:GetTranslation()
	T(x)["=="](5)
	T(y)["=="](10)
	T(z)["=="](15)
end)

T.test("Matrix44 Translate accumulation", function()
	local m = Matrix44()
	m:Translate(10, 0, 0)
	m:Translate(5, 0, 0)
	local x, y, z = m:GetTranslation()
	T(x)["=="](15)
end)

T.test("Matrix44 scale", function()
	local m = Matrix44()
	m:Scale(2, 3, 4)
	T(m.m00)["=="](2)
	T(m.m11)["=="](3)
	T(m.m22)["=="](4)
end)

T.test("Matrix44 multiplication identity", function()
	local m1 = Matrix44()
	local m2 = Matrix44()
	local m3 = m1 * m2
	T(m3.m00)["=="](1)
	T(m3.m11)["=="](1)
	T(m3.m22)["=="](1)
	T(m3.m33)["=="](1)
end)

T.test("Matrix44 multiplication with translation", function()
	local m1 = Matrix44()
	m1:SetTranslation(10, 20, 30)
	local m2 = Matrix44()
	local m3 = m1 * m2
	local x, y, z = m3:GetTranslation()
	T(x)["=="](10)
	T(y)["=="](20)
	T(z)["=="](30)
end)

T.test("Matrix44 inverse", function()
	local m = Matrix44()
	m:SetTranslation(10, 20, 30)
	local inv = m:GetInverse()
	local result = m * inv
	T(result.m00)["~"](1)
	T(result.m11)["~"](1)
	T(result.m22)["~"](1)
	T(result.m33)["~"](1)
end)

T.test("Matrix44 transpose", function()
	local m = Matrix44(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16)
	local t = m:GetTransposed()
	T(t.m01)["=="](m.m10)
	T(t.m10)["=="](m.m01)
	T(t.m02)["=="](m.m20)
	T(t.m20)["=="](m.m02)
end)

T.test("Matrix44 TransformVector", function()
	local m = Matrix44()
	m:SetTranslation(10, 20, 30)
	local x, y, z = m:TransformVector(1, 1, 1)
	T(x)["~"](11)
	T(y)["~"](21)
	T(z)["~"](31)
end)

T.test("Matrix44 rotation around Z axis", function()
	local m = Matrix44()
	m:Rotate(math.pi / 2, 0, 0, 1) -- 90 degrees around Z
	-- Rotating (1,0,0) by 90 degrees around Z should give (0,1,0)
	local x, y, z = m:TransformVector(1, 0, 0)
	T(x)["~"](0)
	T(y)["~"](1)
	T(z)["~"](0)
end)

T.test("Matrix44 GetI/SetI", function()
	local m = Matrix44()
	m:SetI(0, 5)
	T(m:GetI(0))["=="](5)
	m:SetI(5, 10)
	T(m:GetI(5))["=="](10)
end)

T.test("Matrix44 GetField/SetField", function()
	local m = Matrix44()
	m:SetField(1, 2, 42)
	T(m:GetField(1, 2))["=="](42)
end)

T.test("Matrix44 GetRow/SetRow", function()
	local m = Matrix44()
	m:SetRow(0, 1, 2, 3, 4)
	local a, b, c, d = m:GetRow(0)
	T(a)["=="](1)
	T(b)["=="](2)
	T(c)["=="](3)
	T(d)["=="](4)
end)

T.test("Matrix44 GetColumn/SetColumn", function()
	local m = Matrix44()
	m:SetColumn(0, 1, 2, 3, 4)
	local a, b, c, d = m:GetColumn(0)
	T(a)["=="](1)
	T(b)["=="](2)
	T(c)["=="](3)
	T(d)["=="](4)
end)

T.test("Matrix44 Unpack", function()
	local m = Matrix44(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16)
	local vals = {m:Unpack()}
	T(#vals)["=="](16)
	T(vals[1])["=="](1)
	T(vals[16])["=="](16)
end)

T.test("Matrix44 Perspective", function()
	local m = Matrix44()
	m:Perspective(math.rad(60), 0.1, 100, 16 / 9)
	-- Just check it doesn't crash and produces non-identity
	T(m.m00)["~="](1)
	T(m.m11)["~="](1)
end)

T.test("Matrix44 Ortho", function()
	local m = Matrix44()
	m:Ortho(-1, 1, -1, 1, 0.1, 100)
	T(m.m00)["~="](0)
	T(m.m11)["~="](0)
end)

T.test("Matrix44 equality", function()
	local m1 = Matrix44()
	local m2 = Matrix44()
	local m3 = Matrix44()
	m3.m00 = 5
	T(m1)["=="](m2)
	T(m1)["~="](m3)
end)

T.test("Matrix44 Lerp", function()
	local m1 = Matrix44()
	local m2 = Matrix44()
	m2:Scale(3, 3, 3)
	m1:Lerp(0.5, m2)
	T(m1.m00)["~"](2)
	T(m1.m11)["~"](2)
	T(m1.m22)["~"](2)
end)
