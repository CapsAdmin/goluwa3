require("goluwa.global_environment")
local Matrix44 = require("structs.matrix").Matrix44

test("Matrix44 identity construction", function()
	local m = Matrix44()
	ok(m.m00 == 1, "m00 should be 1")
	ok(m.m11 == 1, "m11 should be 1")
	ok(m.m22 == 1, "m22 should be 1")
	ok(m.m33 == 1, "m33 should be 1")
	ok(m.m01 == 0, "m01 should be 0")
	ok(m.m10 == 0, "m10 should be 0")
end)

test("Matrix44 identity method", function()
	local m = Matrix44(2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 2)
	m:Identity()
	ok(m.m00 == 1, "m00 should be 1")
	ok(m.m11 == 1, "m11 should be 1")
	ok(m.m22 == 1, "m22 should be 1")
	ok(m.m33 == 1, "m33 should be 1")
end)

test("Matrix44 copy", function()
	local m1 = Matrix44()
	m1.m00 = 5
	local m2 = m1:Copy()
	ok(m2.m00 == 5, "copied m00 should be 5")
	m2.m00 = 10
	ok(m1.m00 == 5, "original m00 should still be 5")
end)

test("Matrix44 translation", function()
	local m = Matrix44()
	m:SetTranslation(10, 20, 30)
	ok(m.m30 == 10, "translation x should be 10")
	ok(m.m31 == 20, "translation y should be 20")
	ok(m.m32 == 30, "translation z should be 30")
end)

test("Matrix44 GetTranslation", function()
	local m = Matrix44()
	m:SetTranslation(5, 10, 15)
	local x, y, z = m:GetTranslation()
	ok(x == 5, "translation x should be 5")
	ok(y == 10, "translation y should be 10")
	ok(z == 15, "translation z should be 15")
end)

test("Matrix44 Translate accumulation", function()
	local m = Matrix44()
	m:Translate(10, 0, 0)
	m:Translate(5, 0, 0)
	local x, y, z = m:GetTranslation()
	ok(x == 15, "accumulated x translation should be 15")
end)

test("Matrix44 scale", function()
	local m = Matrix44()
	m:Scale(2, 3, 4)
	ok(m.m00 == 2, "scale x should be 2")
	ok(m.m11 == 3, "scale y should be 3")
	ok(m.m22 == 4, "scale z should be 4")
end)

test("Matrix44 multiplication identity", function()
	local m1 = Matrix44()
	local m2 = Matrix44()
	local m3 = m1 * m2
	ok(m3.m00 == 1, "identity * identity m00 should be 1")
	ok(m3.m11 == 1, "identity * identity m11 should be 1")
	ok(m3.m22 == 1, "identity * identity m22 should be 1")
	ok(m3.m33 == 1, "identity * identity m33 should be 1")
end)

test("Matrix44 multiplication with translation", function()
	local m1 = Matrix44()
	m1:SetTranslation(10, 20, 30)
	local m2 = Matrix44()
	local m3 = m1 * m2
	local x, y, z = m3:GetTranslation()
	ok(x == 10, "translation x should be preserved")
	ok(y == 20, "translation y should be preserved")
	ok(z == 30, "translation z should be preserved")
end)

test("Matrix44 inverse", function()
	local m = Matrix44()
	m:SetTranslation(10, 20, 30)
	local inv = m:GetInverse()
	local result = m * inv
	-- Result should be close to identity
	ok(math.abs(result.m00 - 1) < 0.0001, "result m00 should be ~1")
	ok(math.abs(result.m11 - 1) < 0.0001, "result m11 should be ~1")
	ok(math.abs(result.m22 - 1) < 0.0001, "result m22 should be ~1")
	ok(math.abs(result.m33 - 1) < 0.0001, "result m33 should be ~1")
end)

test("Matrix44 transpose", function()
	local m = Matrix44(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16)
	local t = m:GetTransposed()
	ok(t.m01 == m.m10, "transposed m01 should equal original m10")
	ok(t.m10 == m.m01, "transposed m10 should equal original m01")
	ok(t.m02 == m.m20, "transposed m02 should equal original m20")
	ok(t.m20 == m.m02, "transposed m20 should equal original m02")
end)

test("Matrix44 TransformVector", function()
	local m = Matrix44()
	m:SetTranslation(10, 20, 30)
	local x, y, z = m:TransformVector(1, 1, 1)
	ok(math.abs(x - 11) < 0.0001, "transformed x should be 11")
	ok(math.abs(y - 21) < 0.0001, "transformed y should be 21")
	ok(math.abs(z - 31) < 0.0001, "transformed z should be 31")
end)

test("Matrix44 rotation around Z axis", function()
	local m = Matrix44()
	m:Rotate(math.pi / 2, 0, 0, 1) -- 90 degrees around Z
	-- Rotating (1,0,0) by 90 degrees around Z should give (0,1,0)
	local x, y, z = m:TransformVector(1, 0, 0)
	ok(math.abs(x) < 0.0001, "rotated x should be ~0")
	ok(math.abs(y - 1) < 0.0001, "rotated y should be ~1")
	ok(math.abs(z) < 0.0001, "rotated z should be ~0")
end)

test("Matrix44 GetI/SetI", function()
	local m = Matrix44()
	m:SetI(0, 5)
	ok(m:GetI(0) == 5, "GetI(0) should be 5 after SetI(0, 5)")
	m:SetI(5, 10)
	ok(m:GetI(5) == 10, "GetI(5) should be 10 after SetI(5, 10)")
end)

test("Matrix44 GetField/SetField", function()
	local m = Matrix44()
	m:SetField(1, 2, 42)
	ok(m:GetField(1, 2) == 42, "GetField(1,2) should be 42")
end)

test("Matrix44 GetRow/SetRow", function()
	local m = Matrix44()
	m:SetRow(0, 1, 2, 3, 4)
	local a, b, c, d = m:GetRow(0)
	ok(a == 1, "row 0, col 0 should be 1")
	ok(b == 2, "row 0, col 1 should be 2")
	ok(c == 3, "row 0, col 2 should be 3")
	ok(d == 4, "row 0, col 3 should be 4")
end)

test("Matrix44 GetColumn/SetColumn", function()
	local m = Matrix44()
	m:SetColumn(0, 1, 2, 3, 4)
	local a, b, c, d = m:GetColumn(0)
	ok(a == 1, "col 0, row 0 should be 1")
	ok(b == 2, "col 0, row 1 should be 2")
	ok(c == 3, "col 0, row 2 should be 3")
	ok(d == 4, "col 0, row 3 should be 4")
end)

test("Matrix44 Unpack", function()
	local m = Matrix44(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16)
	local vals = {m:Unpack()}
	ok(#vals == 16, "Unpack should return 16 values")
	ok(vals[1] == 1, "first value should be 1")
	ok(vals[16] == 16, "last value should be 16")
end)

test("Matrix44 Perspective", function()
	local m = Matrix44()
	m:Perspective(math.rad(60), 0.1, 100, 16 / 9)
	-- Just check it doesn't crash and produces non-identity
	ok(m.m00 ~= 1 or m.m11 ~= 1, "perspective should modify matrix")
end)

test("Matrix44 Ortho", function()
	local m = Matrix44()
	m:Ortho(-1, 1, -1, 1, 0.1, 100)
	ok(m.m00 ~= 0, "ortho m00 should not be 0")
	ok(m.m11 ~= 0, "ortho m11 should not be 0")
end)

test("Matrix44 equality", function()
	local m1 = Matrix44()
	local m2 = Matrix44()
	local m3 = Matrix44()
	m3.m00 = 5
	ok(m1 == m2, "identical identity matrices should be equal")
	ok(not (m1 == m3), "different matrices should not be equal")
end)

test("Matrix44 Lerp", function()
	local m1 = Matrix44()
	local m2 = Matrix44()
	m2:Scale(3, 3, 3)
	m1:Lerp(0.5, m2)
	ok(math.abs(m1.m00 - 2) < 0.0001, "lerped m00 should be ~2")
	ok(math.abs(m1.m11 - 2) < 0.0001, "lerped m11 should be ~2")
end)
