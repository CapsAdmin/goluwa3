require("test.environment")
local Matrix44 = require("structs.matrix").Matrix44

test("Matrix44 identity construction", function()
	local m = Matrix44()
	attest.equal(m.m00, 1)
	attest.equal(m.m11, 1)
	attest.equal(m.m22, 1)
	attest.equal(m.m33, 1)
	attest.equal(m.m01, 0)
	attest.equal(m.m10, 0)
end)

test("Matrix44 identity method", function()
	local m = Matrix44(2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 2)
	m:Identity()
	attest.equal(m.m00, 1)
	attest.equal(m.m11, 1)
	attest.equal(m.m22, 1)
	attest.equal(m.m33, 1)
end)

test("Matrix44 copy", function()
	local m1 = Matrix44()
	m1.m00 = 5
	local m2 = m1:Copy()
	attest.equal(m2.m00, 5)
	m2.m00 = 10
	attest.equal(m1.m00, 5)
end)

test("Matrix44 translation", function()
	local m = Matrix44()
	m:SetTranslation(10, 20, 30)
	attest.equal(m.m30, 10)
	attest.equal(m.m31, 20)
	attest.equal(m.m32, 30)
end)

test("Matrix44 GetTranslation", function()
	local m = Matrix44()
	m:SetTranslation(5, 10, 15)
	local x, y, z = m:GetTranslation()
	attest.equal(x, 5)
	attest.equal(y, 10)
	attest.equal(z, 15)
end)

test("Matrix44 Translate accumulation", function()
	local m = Matrix44()
	m:Translate(10, 0, 0)
	m:Translate(5, 0, 0)
	local x, y, z = m:GetTranslation()
	attest.equal(x, 15)
end)

test("Matrix44 scale", function()
	local m = Matrix44()
	m:Scale(2, 3, 4)
	attest.equal(m.m00, 2)
	attest.equal(m.m11, 3)
	attest.equal(m.m22, 4)
end)

test("Matrix44 multiplication identity", function()
	local m1 = Matrix44()
	local m2 = Matrix44()
	local m3 = m1 * m2
	attest.equal(m3.m00, 1)
	attest.equal(m3.m11, 1)
	attest.equal(m3.m22, 1)
	attest.equal(m3.m33, 1)
end)

test("Matrix44 multiplication with translation", function()
	local m1 = Matrix44()
	m1:SetTranslation(10, 20, 30)
	local m2 = Matrix44()
	local m3 = m1 * m2
	local x, y, z = m3:GetTranslation()
	attest.equal(x, 10)
	attest.equal(y, 20)
	attest.equal(z, 30)
end)

test("Matrix44 inverse", function()
	local m = Matrix44()
	m:SetTranslation(10, 20, 30)
	local inv = m:GetInverse()
	local result = m * inv
	attest.almost_equal(result.m00, 1)
	attest.almost_equal(result.m11, 1)
	attest.almost_equal(result.m22, 1)
	attest.almost_equal(result.m33, 1)
end)

test("Matrix44 transpose", function()
	local m = Matrix44(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16)
	local t = m:GetTransposed()
	attest.equal(t.m01, m.m10)
	attest.equal(t.m10, m.m01)
	attest.equal(t.m02, m.m20)
	attest.equal(t.m20, m.m02)
end)

test("Matrix44 TransformVector", function()
	local m = Matrix44()
	m:SetTranslation(10, 20, 30)
	local x, y, z = m:TransformVector(1, 1, 1)
	attest.almost_equal(x, 11)
	attest.almost_equal(y, 21)
	attest.almost_equal(z, 31)
end)

test("Matrix44 rotation around Z axis", function()
	local m = Matrix44()
	m:Rotate(math.pi / 2, 0, 0, 1) -- 90 degrees around Z
	-- Rotating (1,0,0) by 90 degrees around Z should give (0,1,0)
	local x, y, z = m:TransformVector(1, 0, 0)
	attest.almost_equal(x, 0, 0.0001)
	attest.almost_equal(y, 1, 0.0001)
	attest.almost_equal(z, 0, 0.0001)
end)

test("Matrix44 GetI/SetI", function()
	local m = Matrix44()
	m:SetI(0, 5)
	attest.equal(m:GetI(0), 5)
	m:SetI(5, 10)
	attest.equal(m:GetI(5), 10)
end)

test("Matrix44 GetField/SetField", function()
	local m = Matrix44()
	m:SetField(1, 2, 42)
	attest.equal(m:GetField(1, 2), 42)
end)

test("Matrix44 GetRow/SetRow", function()
	local m = Matrix44()
	m:SetRow(0, 1, 2, 3, 4)
	local a, b, c, d = m:GetRow(0)
	attest.equal(a, 1)
	attest.equal(b, 2)
	attest.equal(c, 3)
	attest.equal(d, 4)
end)

test("Matrix44 GetColumn/SetColumn", function()
	local m = Matrix44()
	m:SetColumn(0, 1, 2, 3, 4)
	local a, b, c, d = m:GetColumn(0)
	attest.equal(a, 1)
	attest.equal(b, 2)
	attest.equal(c, 3)
	attest.equal(d, 4)
end)

test("Matrix44 Unpack", function()
	local m = Matrix44(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16)
	local vals = {m:Unpack()}
	attest.equal(#vals, 16)
	attest.equal(vals[1], 1)
	attest.equal(vals[16], 16)
end)

test("Matrix44 Perspective", function()
	local m = Matrix44()
	m:Perspective(math.rad(60), 0.1, 100, 16 / 9)
	-- Just check it doesn't crash and produces non-identity
	attest.not_equal(m.m00, 1)
	attest.not_equal(m.m11, 1)
end)

test("Matrix44 Ortho", function()
	local m = Matrix44()
	m:Ortho(-1, 1, -1, 1, 0.1, 100)
	attest.not_equal(m.m00, 0)
	attest.not_equal(m.m11, 0)
end)

test("Matrix44 equality", function()
	local m1 = Matrix44()
	local m2 = Matrix44()
	local m3 = Matrix44()
	m3.m00 = 5
	attest.equal(m1, m2)
	attest.not_equal(m1, m3)
end)

test("Matrix44 Lerp", function()
	local m1 = Matrix44()
	local m2 = Matrix44()
	m2:Scale(3, 3, 3)
	m1:Lerp(0.5, m2)
	attest.almost_equal(m1.m00, 2)
	attest.almost_equal(m1.m11, 2)
	attest.almost_equal(m1.m22, 2)
end)
