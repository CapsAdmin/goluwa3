name: build
on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: checkout the project
        uses: actions/checkout@v4

      - name: install nix package manager
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixpkgs-unstable

      - name: setup magic nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: build luajit 
        run: |
          nix develop --command bash -c "which luajit && luajit -v"
      
      - name: check vulkan environment
        run: |
          nix develop --command bash -c "
            echo '=== Environment Variables ==='
            echo \"VK_LAYER_PATH=\$VK_LAYER_PATH\"
            echo \"VK_ICD_FILENAMES=\$VK_ICD_FILENAMES\"
            echo ''
            echo '=== Validation Layer Files ==='
            ls -la \$VK_LAYER_PATH 2>/dev/null || echo 'VK_LAYER_PATH directory not found'
            echo ''
            echo '=== ICD Driver Files ==='
            ls -la \$(dirname \$VK_ICD_FILENAMES) 2>/dev/null || echo 'ICD directory not found'
            echo ''
            echo '=== Vulkan Instance Layers ==='
            vulkaninfo --summary 2>&1 | grep -A 20 'Instance Layers:' || echo 'No layers info'
            echo ''
            echo '=== Vulkan Device Info ==='
            vulkaninfo --summary 2>&1 | grep -E '(deviceName|driverName|apiVersion)' || echo 'vulkaninfo failed'
          "
      
      - name: run tests
        run: |
          nix develop --command bash -c "luajit glw test --verbose"